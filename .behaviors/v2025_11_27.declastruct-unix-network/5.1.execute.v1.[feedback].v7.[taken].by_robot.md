# feedback v7 response

## 1. plan

- [ ] blocker 4: rename `context.override` to `context.osUnixNetwork.repo` with required fields; set defaults in getProvider
- [ ] blocker 1: eliminate all `if (needsSudo)` conditionals - always use execa for consistency
- [ ] blocker 2: move `unitDir` from parameter to `context.osUnixNetwork.repo`
- [ ] blocker 3: simplify `setUnixPortAlias` - remove redundant if block for upsert

note: addressed blocker 4 first since the context restructuring affects all other changes

---

## 2. execution

### blocker 4: context restructuring

updated `ContextUnixNetwork` to use required fields instead of optional overrides:

**src/domain.objects/ContextUnixNetwork.ts**
```typescript
export interface ContextUnixNetwork {
  osUnixNetwork: {
    repo: {
      etcHostsPath: string;
      systemdUnitsDir: string;
    };
  };
}
```

updated `getDeclastructUnixNetworkProvider` to set defaults:

**src/domain.operations/provider/getDeclastructUnixNetworkProvider.ts**
```typescript
export const getDeclastructUnixNetworkProvider = (
  input: {
    repo?: {
      etcHostsPath?: string;
      systemdUnitsDir?: string;
    };
  },
  context: ContextLogTrail,
): DeclastructUnixNetworkProvider => {
  const providerContext: ContextUnixNetwork & ContextLogTrail = {
    ...context,
    osUnixNetwork: {
      repo: {
        etcHostsPath: input.repo?.etcHostsPath ?? DEFAULT_HOSTS_FILE_PATH,
        systemdUnitsDir: input.repo?.systemdUnitsDir ?? DEFAULT_SYSTEMD_UNIT_DIR,
      },
    },
  };
  // ...
};
```

### blocker 1: eliminate needsSudo conditionals

replaced all `if (needsSudo)` conditionals with consistent execa usage:

**src/access/sdks/osUnixHostsFile/dop.getOsUnixHostsFileLines.ts**
- changed from `readFile()` to `execa('cat', [hostsPath])`

**src/access/sdks/osUnixHostsFile/dop.addOsUnixHostsFileLine.ts**
- removed `needsSudo` check, now always uses `execa('tee', ['-a', hostsPath])`

**src/access/sdks/osUnixHostsFile/dop.replaceOsUnixHostsFileLine.ts**
- replaced `readFile()` with `execa('cat', [hostsPath])`
- removed `needsSudo` check, now always uses `execa('tee', [hostsPath])`

**src/access/sdks/osUnixSystemdSocat/dop.getOsUnixSystemdSocatServices.ts**
- eliminated `if (needsSudo)` branch with `readdir`/`readFile`
- now consistently uses `execa('bash', [...])` for listing and `execa('cat', [uri])` for reading

**src/access/sdks/osUnixSystemdSocat/dop.setOsUnixSystemdSocatService.ts**
- removed `needsSudo` check, now always uses `execa('tee', [uri])`
- systemctl operations still use sudo (only for system path)

### blocker 2: move unitDir to context

**src/domain.operations/portAlias/castFromDeclaredUnixPortAlias.ts**
```typescript
export const castFromDeclaredUnixPortAlias = (
  input: { alias: DeclaredUnixPortAlias },
  context: ContextUnixNetwork,
): OsUnixSystemdSocatService => {
  const unitDir = context.osUnixNetwork.repo.systemdUnitsDir;
  // ...
};
```

### blocker 3: simplify setUnixPortAlias

**src/domain.operations/portAlias/setUnixPortAlias.ts**

before (redundant):
```typescript
if (found && input.upsert && (different target)) {
  await osUnixSystemdSocatSdk.setOsUnixSystemdSocatService({ service }, context);
  return new DeclaredUnixPortAlias({ ...desired, uri: service.uri });
}

// not found - add via SDK
await osUnixSystemdSocatSdk.setOsUnixSystemdSocatService({ service }, context);
return new DeclaredUnixPortAlias({ ...desired, uri: service.uri });
```

after (simplified):
```typescript
// cast to OS-level representation (unitDir comes from context)
const service = castFromDeclaredUnixPortAlias({ alias: desired }, context);

// create or update service via SDK (idempotent - safe to overwrite)
await osUnixSystemdSocatSdk.setOsUnixSystemdSocatService({ service }, context);

return new DeclaredUnixPortAlias({ ...desired, uri: service.uri });
```

---

## 3. confirmation

### blocker 4 ✓
- [x] `ContextUnixNetwork.ts:5-24` - context now uses `osUnixNetwork.repo` with required fields
- [x] `getDeclastructUnixNetworkProvider.ts:15-33` - defaults set in provider

### blocker 1 ✓
- [x] `dop.getOsUnixHostsFileLines.ts:17` - now uses `execa('cat', [hostsPath])`
- [x] `dop.addOsUnixHostsFileLine.ts:32` - always uses `execa('tee', ['-a', hostsPath])`
- [x] `dop.replaceOsUnixHostsFileLine.ts:26,45` - uses execa for read and write
- [x] `dop.getOsUnixSystemdSocatServices.ts:17-24,35` - uses execa throughout
- [x] `dop.setOsUnixSystemdSocatService.ts:25` - always uses `execa('tee', [uri])`

### blocker 2 ✓
- [x] `castFromDeclaredUnixPortAlias.ts:34-38` - now takes context, gets unitDir from `context.osUnixNetwork.repo.systemdUnitsDir`
- [x] `setUnixPortAlias.ts:50` - calls castFromDeclaredUnixPortAlias with context instead of unitDir param

### blocker 3 ✓
- [x] `setUnixPortAlias.ts:49-58` - simplified to single block without redundant conditional

---

## verification

```
npm run test:types  # passes
npm run test:unit   # 39 tests pass
```

all tests updated to use new context structure with `osUnixNetwork.repo`.
