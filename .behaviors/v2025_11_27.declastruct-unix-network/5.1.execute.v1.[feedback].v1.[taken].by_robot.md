# feedback response

## blocker.1 — namespace raw resources as `OsUnix*`

**understood.**

`HostsFileEntry` => `OsUnixHostsFileEntry`

the naming convention:
- `DeclaredUnix*` = our declarative contract (what the user declares)
- `OsUnix*` = the raw os-level resources we interface with (adapter layer)

this makes the boundary crystal clear.

---

## blocker.2 — use `ContextLogTrail` instead of `VisualogicContext`

**understood.**

`VisualogicContext` is too heavy — we only need the log trail. will replace all usages with `ContextLogTrail` from `simple-log-methods`.

---

## blocker.3 — prefix all exports with `Unix`

**understood.**

- `getHostAlias` => `getUnixHostAlias`
- `setHostAlias` => `setUnixHostAlias`
- `getHostAliases` => `getUnixHostAliases`
- `getPortAlias` => `getUnixPortAlias`
- `setPortAlias` => `setUnixPortAlias`
- `getPortAliases` => `getUnixPortAliases`

makes imports unambiguous when used alongside other providers.

---

## blocker.4 — rename to `parseOsUnixHostsFile.ts`

**understood.**

`src/domain.operations/hostAlias/parseHostsFile.ts` => `src/domain.operations/hostAlias/adapter/parseOsUnixHostsFile.ts`

the `OsUnix` prefix signals this is the adapter layer interfacing with the raw os resource.

---

## blocker.5 — `getUnixHostAlias` should use `getUnixHostAliases`

**understood.**

currently `getUnixHostAlias` duplicates the file reading/parsing logic. it should:

```ts
export const getUnixHostAlias = async (input, context) => {
  const aliases = await getUnixHostAliases({}, context);
  return aliases.find((a) => a.from === input.by.unique.from) ?? null;
};
```

this respects the layer hierarchy — don't drop to adapter level when domain level suffices.

---

## blocker.6 — separate adapter functions into own files

**understood.**

```
src/domain.operations/hostAlias/adapter/
├── parseOsUnixHostsFileLine.ts
├── parseOsUnixHostsFile.ts
├── formatDeclaredUnixHostAliasAsHostsLine.ts
└── readOsUnixHostsFile.ts
```

each function gets its own file, following single-responsibility.

---

## blocker.7 — `setUnixHostAlias` should use `getUnixHostAlias`

**understood.**

currently drops to adapter level unnecessarily:

```ts
// ⛔ bad — drops to adapter level
const content = await readHostsFile({}, context);
const entries = parseHostsFile({ content });
const existingEntry = entries.find(...);
```

should use domain level:

```ts
// ✅ good — uses domain level
const existing = await getUnixHostAlias({ by: { unique: { via: desired.via, from: desired.from } } }, context);
if (existing && input.findsert) return existing;
```

only drop to adapter level when actually writing.

---

## blocker.8 — `setUnixHostAlias` should append-only, fail fast otherwise

**understood.**

the current implementation overwrites the entire file, which is dangerous and unnecessary.

correct approach:
1. check if entry exists via `getUnixHostAlias`
2. if findsert and exists → return existing
3. if upsert and exists with same ip → return existing
4. if upsert and exists with different ip → `BadRequestError.throw('cannot upsert host alias; entry exists with different ip. delete first.')`
5. if not exists → append new line only

append-only is safer and idempotent. if user needs to change an ip, they must explicitly delete first.

---

## blocker.9 — same adapter layer distinction for `portAlias`

**understood.**

```
src/domain.operations/portAlias/adapter/
├── parseOsUnixSocatServiceUnit.ts
├── generateOsUnixSocatServiceUnit.ts
├── generateOsUnixSocatServiceName.ts
├── readOsUnixSocatServiceUnit.ts
└── writeOsUnixSocatServiceUnit.ts
```

and `setUnixPortAlias` should use `getUnixPortAlias` to check existence before dropping to adapter level.

---

## action plan

1. rename types: `HostsFileEntry` => `OsUnixHostsFileEntry`
2. replace `VisualogicContext` with `ContextLogTrail`
3. prefix all exports: `get/set/getAll` => `getUnix*/setUnix*/getUnix*s`
4. create adapter subdirectories with separated files
5. refactor `getUnixHostAlias` to use `getUnixHostAliases`
6. refactor `setUnixHostAlias` to use `getUnixHostAlias` + append-only
7. apply same patterns to `portAlias`
8. update tests to match new names and behavior
