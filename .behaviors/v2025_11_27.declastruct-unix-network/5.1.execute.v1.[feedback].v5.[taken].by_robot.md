# feedback v6 response: blockers 1-7 addressed

all 7 blockers have been addressed. type check passes and all 39 unit tests pass.

---

## blocker 1: rename OsUnixHostsFileLine to OsUnixHostsFileEntry

**done**

- renamed the file from `dobj.OsUnixHostsFileLine.ts` to `dobj.OsUnixHostsFileEntry.ts`
- kept `OsUnixHostsFileLine` as a type alias for raw line string
- `OsUnixHostsFileEntry` is the parsed interface with `ip`, `hostnames`, `comment`
- updated all cast functions and operations to use the new naming

```typescript
// src/access/sdks/osUnixHostsFile/dobj.OsUnixHostsFileEntry.ts
export type OsUnixHostsFileLine = string;

export interface OsUnixHostsFileEntry {
  ip: string;
  hostnames: string[];
  comment?: string;
}
```

---

## blocker 2: remove OsUnixHostsFileLineInput interface, add runtime failfast

**done**

- deleted `dobj.OsUnixHostsFileLineInput.ts`
- added runtime failfast in `addOsUnixHostsFileEntry`:

```typescript
// src/access/sdks/osUnixHostsFile/dop.addOsUnixHostsFileLine.ts
if (input.entry.hostnames.length > 1)
  BadRequestError.throw(
    'only single hostname per entry supported for isolation and maintainability',
    { hostnames: input.entry.hostnames },
  );
```

---

## blocker 3: restore SDK export patterns

**done**

- osUnixHostsFile index.ts exports `osUnixHostsFileSdk`
- osUnixSystemdSocat index.ts exports `osUnixSystemdSocatSdk`

```typescript
// src/access/sdks/osUnixHostsFile/index.ts
export const osUnixHostsFileSdk = {
  getOsUnixHostsFileEntries,
  addOsUnixHostsFileEntry,
  replaceOsUnixHostsFileEntry,
};

// src/access/sdks/osUnixSystemdSocat/index.ts
export const osUnixSystemdSocatSdk = {
  getOsUnixSystemdSocatServices,
  setOsUnixSystemdSocatService,
};
```

---

## blocker 4: fix/document sudo tee behavior

**done**

- added comment explaining that `tee` without `-a` overwrites (not appends):

```typescript
// src/access/sdks/osUnixHostsFile/dop.replaceOsUnixHostsFileLine.ts
// write using tee (overwrites file completely - tee without -a replaces content)
const args = needsSudo
  ? ['sudo', 'tee', hostsPath]
  : ['tee', hostsPath];
await execa(args[0]!, args.slice(1), { input: newContent });
```

---

## blocker 5: use execa consistently for all write operations

**done**

- all write operations now use execa for both sudo and non-sudo paths:

```typescript
// example from dop.addOsUnixHostsFileLine.ts
const args = needsSudo
  ? ['sudo', 'tee', '-a', hostsPath]
  : ['tee', '-a', hostsPath];
await execa(args[0]!, args.slice(1), { input: lineContent });

// example from dop.setOsUnixSystemdSocatService.ts
const writeArgs = needsSudo
  ? ['sudo', 'tee', input.service.uri]
  : ['tee', input.service.uri];
await execa(writeArgs[0]!, writeArgs.slice(1), { input: content });
```

---

## blocker 6: rename serviceName to uri, expose as optional metadata

**done**

- renamed `serviceName` to `uri` in `OsUnixSystemdSocatService`
- added optional `uri` field to `DeclaredUnixPortAlias` as metadata
- uri is populated after persistence (autogenerated from `from` endpoint)

```typescript
// src/access/sdks/osUnixSystemdSocat/dobj.OsUnixSystemdSocatService.ts
export interface OsUnixSystemdSocatService {
  uri: string;
  listenHost: string;
  listenPort: number;
  connectHost: string;
  connectPort: number;
}

// src/domain.objects/DeclaredUnixPortAlias.ts
export interface DeclaredUnixPortAlias {
  /**
   * .what = systemd service unit file path
   * .note = @metadata -> only known after persistence, autogenerated
   */
  uri?: string;
  via: 'systemd-socat';
  from: UnixPortEndpoint;
  into: UnixPortEndpoint;
}
```

note: `primary = ['uri']` was dropped for now due to declastruct type constraints (optional metadata vs required primary key). TODO comment added to revisit once declastruct supports optional metadata as primary key.

---

## blocker 7: make non-sudo path use execa like sudo path

**done**

- all operations now use execa uniformly for both paths
- see blocker 5 examples above

---

## verification

```
npm run test:types  # passes
npm run test:unit   # 39 tests pass
```

---

## files changed

### SDK layer (access/sdks/osUnixHostsFile)
- `dobj.OsUnixHostsFileEntry.ts` (renamed from dobj.OsUnixHostsFileLine.ts)
- `castIntoOsUnixHostsFileEntry.ts`
- `castFromOsUnixHostsFileEntry.ts`
- `dop.addOsUnixHostsFileLine.ts` -> `addOsUnixHostsFileEntry`
- `dop.replaceOsUnixHostsFileLine.ts` -> `replaceOsUnixHostsFileEntry`
- `dop.getOsUnixHostsFileLines.ts` -> `getOsUnixHostsFileEntries`
- `index.ts`
- deleted: `dobj.OsUnixHostsFileLineInput.ts`

### SDK layer (access/sdks/osUnixSystemdSocat)
- `dobj.OsUnixSystemdSocatService.ts` (serviceName -> uri)
- `castIntoOsUnixSystemdSocatService.ts`
- `castFromOsUnixSystemdSocatService.ts`
- `dop.setOsUnixSystemdSocatService.ts`
- `index.ts`

### domain layer
- `DeclaredUnixPortAlias.ts` (added optional uri field)
- `DeclastructUnixNetworkProvider.ts`
- `castFromDeclaredUnixHostAlias.ts`
- `castIntoDeclaredUnixHostAlias.ts`
- `getUnixHostAliases.ts`
- `setUnixHostAlias.ts`
- `castFromDeclaredUnixPortAlias.ts`
- `setUnixPortAlias.ts`
- `getDeclastructUnixNetworkProvider.ts`

### tests
- `castFromOsUnixSystemdSocatService.test.ts`
- `setUnixHostAlias.test.ts`
