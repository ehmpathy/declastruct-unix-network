# feedback response v3

## plan

checklist of changes:
- [ ] blocker 1: use OS-native terms in `OsUnixSystemdSocatService` (socat's `TCP-LISTEN` / `TCP` terminology)
- [ ] blocker 2: remove `isManagedByDeclastruct` from `OsUnixHostsFileLine` (not an OS attribute)
- [ ] update cast functions to handle transformation between OS and domain terms
- [ ] update tests to match new terminology
- [ ] run tests and verify

---

## execution

### blocker 1: use socat's native terminology

**understood.**

the issue: `OsUnixSystemdSocatService` used declarative terms (`fromHost`, `fromPort`, `intoHost`, `intoPort`) instead of socat's native terminology.

socat uses:
- `TCP-LISTEN:<port>,bind=<addr>` for the listening side
- `TCP:<host>:<port>` for the connect/forward side

@see https://linux.die.net/man/1/socat

renamed to:
```ts
export interface OsUnixSystemdSocatService {
  serviceName: string;
  bindAddress: string;   // was: fromHost (socat's `bind=` option)
  listenPort: number;    // was: fromPort (socat's `TCP-LISTEN:<port>`)
  connectHost: string;   // was: intoHost (socat's `TCP:<host>:<port>`)
  connectPort: number;   // was: intoPort (socat's `TCP:<host>:<port>`)
}
```

added jsdoc comments with `.what` and `.why` explanations plus `@see` links to socat documentation.

---

### blocker 2: remove isManagedByDeclastruct from OsUnixHostsFileLine

**understood.**

the issue: `isManagedByDeclastruct` is not an attribute the OS exposes. the hosts file format only has:
- ip address
- hostnames
- optional comment

@see https://man7.org/linux/man-pages/man5/hosts.5.html

removed the attribute:
```ts
export interface OsUnixHostsFileLine {
  ip: string;
  hostnames: string[];
  comment?: string;
  // removed: isManagedByDeclastruct: boolean;
}
```

moved the "managed by declastruct" detection logic to the domain layer:
- created `DECLASTRUCT_MANAGED_COMMENT` constant in `castFromDeclaredUnixHostAlias.ts`
- created `isManagedByDeclastruct()` helper in `castIntoDeclaredUnixHostAlias.ts`
- updated `getUnixHostAliases.ts` to use the helper for filtering

---

### update cast functions

**understood.**

the cast functions now handle the terminology transformation between OS and domain layers.

**portAlias casts:**
- `castFromDeclaredUnixPortAlias`: maps `from.host/port` → `bindAddress/listenPort`, `into.host/port` → `connectHost/connectPort`
- `castIntoDeclaredUnixPortAlias`: maps `bindAddress/listenPort` → `from`, `connectHost/connectPort` → `into`

**hostAlias casts:**
- `castFromDeclaredUnixHostAlias`: maps `from` → `hostnames[0]`, `into` → `ip`, adds `comment: 'managed by declastruct'`
- `castIntoDeclaredUnixHostAlias`: maps `ip` → `into`, `hostname` → `from`
- `isManagedByDeclastruct`: checks if `comment` contains the managed marker

---

### update tests

**understood.**

updated test assertions to match new OS-native terminology:
- `setUnixHostAlias.test.ts`: expects `comment: 'managed by declastruct'` instead of `isManagedByDeclastruct: true`
- `setUnixPortAlias.test.ts`: expects `bindAddress`, `listenPort`, `connectHost`, `connectPort` instead of `fromHost`, `fromPort`, `intoHost`, `intoPort`

---

## confirmation

- [x] blocker 1: renamed to socat's native terms in `src/access/sdks/osUnixSystemdSocat/dobj.OsUnixSystemdSocatService.ts:9-48`
- [x] blocker 2: removed `isManagedByDeclastruct` from `src/access/sdks/osUnixHostsFile/dobj.OsUnixHostsFileLine.ts:11-35`
- [x] updated cast functions:
  - `src/domain.operations/portAlias/castFromDeclaredUnixPortAlias.ts:29-39`
  - `src/domain.operations/portAlias/castIntoDeclaredUnixPortAlias.ts:17-32`
  - `src/domain.operations/hostAlias/castFromDeclaredUnixHostAlias.ts:4-27`
  - `src/domain.operations/hostAlias/castIntoDeclaredUnixHostAlias.ts:5-32`
- [x] updated `getUnixHostAliases.ts` to use domain-layer filtering at lines 6-8, 30-31
- [x] updated SDK operations:
  - `src/access/sdks/osUnixSystemdSocat/dop.addOsUnixSystemdSocatService.ts:16-22`
  - `src/access/sdks/osUnixSystemdSocat/dop.getOsUnixSystemdSocatServices.ts:17-35`
  - `src/access/sdks/osUnixHostsFile/dop.getOsUnixHostsFileLines.ts:37-41`
- [x] tests pass: 10 unit tests, 6 integration tests

---

## updated architecture

the layer separation is now:

```
src/access/sdks/*
├── osUnixHostsFile/
│   ├── dobj.OsUnixHostsFileLine.ts    # OS-native: ip, hostnames, comment
│   ├── dop.getOsUnixHostsFileLines.ts # reads raw hosts file
│   └── dop.addOsUnixHostsFileLine.ts  # writes raw hosts file
└── osUnixSystemdSocat/
    ├── dobj.OsUnixSystemdSocatService.ts  # socat-native: bindAddress, listenPort, connectHost, connectPort
    ├── dop.getOsUnixSystemdSocatServices.ts
    └── dop.addOsUnixSystemdSocatService.ts

src/domain.operations/*
├── hostAlias/
│   ├── castFromDeclaredUnixHostAlias.ts   # domain → OS (adds managed comment)
│   ├── castIntoDeclaredUnixHostAlias.ts   # OS → domain (+ isManagedByDeclastruct helper)
│   ├── getUnixHostAlias.ts
│   ├── getUnixHostAliases.ts              # uses domain-layer filtering
│   └── setUnixHostAlias.ts
└── portAlias/
    ├── castFromDeclaredUnixPortAlias.ts   # domain (from/into) → OS (bind/listen/connect)
    ├── castIntoDeclaredUnixPortAlias.ts   # OS (bind/listen/connect) → domain (from/into)
    ├── getUnixPortAlias.ts
    ├── getUnixPortAliases.ts
    └── setUnixPortAlias.ts
```

the principle:
- `access/sdks/*` = OS-level operations on raw resources, using exact OS terminology
- `domain.operations/*` = domain-level operations with cast functions handling the transformation between OS and domain terms
