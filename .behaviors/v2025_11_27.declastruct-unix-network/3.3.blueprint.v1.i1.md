# blueprint: declastruct-unix-network

## overview

implement declarative management of unix network resources following the patterns established in `declastruct-github`. the framework enables users to declare desired state for resources like host aliases (`/etc/hosts`) and port forwarding (`systemd-socat`), then `get` current state and `set` desired state idempotently.

---

## domain resources

### 1. `DeclaredUnixHostAlias`

```ts
// src/domain.objects/DeclaredUnixHostAlias.ts
interface DeclaredUnixHostAlias {
  /**
   * .what = mechanism used to manage the alias
   * .note = currently only '/etc/hosts' is supported
   */
  via: '/etc/hosts';

  /**
   * .what = hostname to alias (the source)
   */
  from: string;

  /**
   * .what = ip address to resolve to (the target)
   */
  into: string;
}
```

- unique: `['via', 'from']` — a hostname can only resolve to one ip per mechanism

### 2. `DeclaredUnixPortAlias`

```ts
// src/domain.objects/DeclaredUnixPortAlias.ts
interface DeclaredUnixPortAlias {
  /**
   * .what = mechanism used to manage the port forwarding
   * .note = currently only 'systemd-socat' is supported
   */
  via: 'systemd-socat';

  /**
   * .what = source endpoint to listen on
   */
  from: { host: string; port: number };

  /**
   * .what = target endpoint to forward to
   */
  into: { host: string; port: number };

  /**
   * .what = optional name for the systemd service
   * .note = derived from from.host:from.port if not provided
   */
  serviceName?: string;
}
```

- unique: `['via', 'from']` — a source endpoint can only forward to one destination per mechanism

---

## context

unlike `declastruct-github` which requires an api token, unix network operations run locally and don't require credentials. the context is minimal:

```ts
// src/domain.objects/ContextUnixNetwork.ts
interface ContextUnixNetwork {
  // no credentials needed — operations run locally via shell
}
```

---

## operations structure

### host alias operations

```
src/domain.operations/hostAlias/
├── getHostAlias.ts              // get current state from /etc/hosts
├── getHostAlias.integration.test.ts
├── getHostAliases.ts            // list all aliases from /etc/hosts
├── getHostAliases.integration.test.ts
├── setHostAlias.ts              // upsert/findsert alias in /etc/hosts
├── setHostAlias.test.ts
├── setHostAlias.integration.test.ts
├── castToDeclaredUnixHostAlias.ts
└── parseHostsFile.ts            // helper to parse /etc/hosts format
```

### port alias operations

```
src/domain.operations/portAlias/
├── getPortAlias.ts              // get current state from systemd
├── getPortAlias.integration.test.ts
├── getPortAliases.ts            // list all socat services
├── getPortAliases.integration.test.ts
├── setPortAlias.ts              // upsert/findsert systemd-socat service
├── setPortAlias.test.ts
├── setPortAlias.integration.test.ts
├── castToDeclaredUnixPortAlias.ts
├── generateSocatServiceUnit.ts  // generate systemd unit content
└── parseSocatServiceUnit.ts     // parse existing service unit
```

---

## daos

```ts
// src/access/daos/DeclaredUnixHostAliasDao.ts
export const DeclaredUnixHostAliasDao = new DeclastructDao<...>({
  get: { byUnique, byRef },
  set: { findsert, upsert },
});

// src/access/daos/DeclaredUnixPortAliasDao.ts
export const DeclaredUnixPortAliasDao = new DeclastructDao<...>({
  get: { byUnique, byRef },
  set: { findsert, upsert },
});
```

---

## provider

```ts
// src/domain.objects/DeclastructUnixNetworkProvider.ts
type DeclastructUnixNetworkProvider = DeclastructProvider<
  {
    DeclaredUnixHostAlias: DeclastructDao<...>;
    DeclaredUnixPortAlias: DeclastructDao<...>;
  },
  ContextUnixNetwork & ContextLogTrail
>;

// src/domain.operations/provider/getDeclastructUnixNetworkProvider.ts
export const getDeclastructUnixNetworkProvider = (
  input: {},
  context: ContextLogTrail,
): DeclastructUnixNetworkProvider => { ... };
```

---

## public sdk exports

```ts
// src/contract/sdks/index.ts
export { getDeclastructUnixNetworkProvider } from '...';
export type { DeclastructUnixNetworkProvider } from '...';
export { DeclaredUnixHostAlias } from '...';
export { DeclaredUnixPortAlias } from '...';
```

---

## implementation details

### host alias (`/etc/hosts`)

**get:**
1. read `/etc/hosts` file
2. parse lines, skipping comments and empty lines
3. match line where hostname matches `from`
4. return `DeclaredUnixHostAlias` or `null`

**set:**
1. read current hosts file
2. check if entry exists for `from`
3. if findsert and exists → return existing
4. if upsert and exists → update ip address
5. if not exists → append new line
6. write file back (requires sudo or elevated permissions)

**format:** `{into}    {from}    # managed by declastruct`

### port alias (`systemd-socat`)

**service name convention:** `declastruct-socat-{from.host}-{from.port}.service`

**get:**
1. check if systemd service exists via `systemctl show`
2. parse service unit file to extract from/into values
3. return `DeclaredUnixPortAlias` or `null`

**set:**
1. check if service exists
2. if findsert and exists → return existing
3. if upsert and exists → update unit file if different
4. if not exists → create new service unit
5. reload systemd daemon
6. enable and start service

**systemd unit template:**
```ini
[Unit]
Description=Declastruct socat port forward {from.host}:{from.port} -> {into.host}:{into.port}
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/socat TCP-LISTEN:{from.port},bind={from.host},fork,reuseaddr TCP:{into.host}:{into.port}
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

---

## file structure summary

```
src/
├── contract/
│   └── sdks/
│       ├── index.ts                          # public exports
│       └── declastruct.acceptance.test.ts
├── access/
│   ├── daos/
│   │   ├── DeclaredUnixHostAliasDao.ts
│   │   └── DeclaredUnixPortAliasDao.ts
│   └── sdks/
│       └── (none needed - shell access via execa)
├── domain.objects/
│   ├── ContextUnixNetwork.ts             # empty — no credentials needed
│   ├── DeclaredUnixHostAlias.ts
│   ├── DeclaredUnixPortAlias.ts
│   └── DeclastructUnixNetworkProvider.ts
└── domain.operations/
    ├── hostAlias/
    │   ├── getHostAlias.ts
    │   ├── getHostAliases.ts
    │   ├── setHostAlias.ts
    │   ├── castToDeclaredUnixHostAlias.ts
    │   └── parseHostsFile.ts
    ├── portAlias/
    │   ├── getPortAlias.ts
    │   ├── getPortAliases.ts
    │   ├── setPortAlias.ts
    │   ├── castToDeclaredUnixPortAlias.ts
    │   ├── generateSocatServiceUnit.ts
    │   └── parseSocatServiceUnit.ts
    └── provider/
        └── getDeclastructUnixNetworkProvider.ts
```

---

## usage example (from wish)

```ts
import {
  getDeclastructUnixNetworkProvider,
  DeclaredUnixHostAlias,
  DeclaredUnixPortAlias,
} from 'declastruct-unix-network';

// get provider
const provider = getDeclastructUnixNetworkProvider({}, { log });

// declare resources
const hostAliasProd = new DeclaredUnixHostAlias({
  via: '/etc/hosts',
  from: 'aws.ssmproxy.ahbodedb.prod',
  into: '127.0.0.1',
});

const portAliasProd = new DeclaredUnixPortAlias({
  via: 'systemd-socat',
  from: { host: '127.0.0.1', port: 5433 },
  into: { host: '127.0.0.1', port: 15433 },
});

// get current state
const currentHost = await provider.daos.DeclaredUnixHostAlias.get.byUnique(
  { via: '/etc/hosts', from: 'aws.ssmproxy.ahbodedb.prod' },
);

const currentPort = await provider.daos.DeclaredUnixPortAlias.get.byUnique(
  { via: 'systemd-socat', from: { host: '127.0.0.1', port: 5433 } },
);

// set desired state (idempotent)
await provider.daos.DeclaredUnixHostAlias.set.upsert(hostAliasProd);
await provider.daos.DeclaredUnixPortAlias.set.upsert(portAliasProd);
```

---

## dependencies

- `execa` — for shell command execution (reading/writing files, systemctl commands)
- `declastruct` — core framework
- `domain-objects` — domain modeling
- `helpful-errors` — error handling
- `as-procedure` — procedure wrapping

---

## implementation order

1. domain objects (`DeclaredUnixHostAlias`, `DeclaredUnixPortAlias`, context)
2. host alias operations (simpler - file parsing only)
3. host alias dao
4. port alias operations (more complex - systemd interaction)
5. port alias dao
6. provider
7. public sdk exports
8. acceptance tests
